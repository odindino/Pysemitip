# Fortran 程式碼結構分析

## 📁 Fortran 檔案總覽

### 主要檔案列表
```
src/fortran/MultInt/
├── MultInt3-6.4.f        # 主程式 (最新版本)
├── MultInt3-6.3.f        # 主程式 (舊版本)
├── semitip3-6.1.f        # Poisson 方程求解器
├── intcurr-6.2.f         # 穿隧電流計算
├── semirhomult-6.0.f     # 體電荷密度計算
├── surfrhomult-6.2.f     # 表面電荷密度計算
├── potcut3-6.0.f         # 電位剖面切割
├── potexpand-6.1.f       # 電位展開計算
├── gsect-6.0.f           # 數值求根方法
├── contr3-6.0.f          # 輔助控制函數
├── fort_MultInt.9        # 輸入參數檔案
└── fort_MultInt.16       # 標準輸出檔案
```

## 🔍 各檔案詳細分析

### 1. MultInt3-6.4.f (主程式)

#### 基本資訊
- **版本**: 6.4 (2015年10月)
- **功能**: STM 模擬主控制程式
- **行數**: 738 行
- **關鍵特色**: 支援多區域半導體、3D 電場計算、穿隧電流積分

#### 程式結構
```fortran
PROGRAM MultInt3
├── 參數定義 (PARAMETER statements)
├── 陣列宣告 (DIMENSION statements)
├── COMMON 區塊定義
├── 輸入參數讀取
├── 初始化設定
├── 電壓掃描迴圈
│   ├── 電荷密度表格計算
│   ├── Poisson 方程求解 (呼叫 SEMITIP3)
│   └── 穿隧電流計算 (呼叫 INTCURR)
└── 結果輸出
```

#### 關鍵子程序
- `RHOSURF`: 表面電荷密度計算 (在檔案末尾定義)
- `RHOBULK`: 體電荷密度計算 (在檔案末尾定義)

#### 重要變數
```fortran
VAC(2,NRDIM,NVDIM,NPDIM)     # 真空區電位
SEM(2,NRDIM,NSDIM,NPDIM)     # 半導體區電位
VSINT(2,NRDIM,NPDIM)         # 表面積分電位
BBIAS(1000)                  # 偏壓陣列
NLOC(4)                      # 局域化態數量
```

### 2. semitip3-6.1.f (Poisson 求解器)

#### 基本資訊
- **版本**: 6.1 (2011年2月)
- **功能**: 3D Poisson 方程數值求解
- **行數**: 約 1200+ 行
- **方法**: 有限差分法 + SOR (Successive Over-Relaxation)

#### 程式結構
```fortran
SUBROUTINE SEMITIP3
├── 網格設定
├── 邊界條件設定
├── 多網格求解迴圈
│   ├── SOR 迭代
│   ├── 收斂檢查
│   └── 網格細化
└── 結果返回
```

#### 關鍵特色
- **多網格方法**: 從粗網格到細網格逐步求解
- **非線性處理**: 透過 GSECT 方法處理電荷密度非線性
- **邊界條件**: 複雜的邊界條件處理

### 3. intcurr-6.2.f (電流計算)

#### 基本資訊
- **版本**: 6.2 (2011年6月)
- **功能**: Schrödinger 方程求解和穿隧電流計算
- **方法**: 沿中軸積分 Schrödinger 方程

#### 主要功能
- 局域化態搜尋
- 波函數計算
- 穿隧機率計算
- 電流密度積分

### 4. semirhomult-6.0.f (體電荷密度)

#### 基本資訊
- **版本**: 6.0
- **功能**: 計算半導體體內電荷密度
- **物理模型**: 載流子統計、能帶結構

#### 關鍵函數
```fortran
SUBROUTINE SEMIRHOMULT
├── 費米能階計算
├── 載流子濃度計算
├── 電荷密度插值表建立
└── 電荷密度函數返回
```

### 5. surfrhomult-6.2.f (表面電荷密度)

#### 基本資訊
- **版本**: 6.2
- **功能**: 計算表面態電荷密度
- **模型**: 表面態分佈、費米統計

### 6. potcut3-6.0.f (電位剖面)

#### 基本資訊
- **版本**: 6.0
- **功能**: 提取特定路徑的電位剖面
- **用途**: 分析和可視化

### 7. potexpand-6.1.f (電位展開)

#### 基本資訊
- **版本**: 6.1
- **功能**: 電位的多極展開
- **數學**: 球諧函數展開

### 8. gsect-6.0.f (數值方法)

#### 基本資訊
- **版本**: 6.0
- **功能**: 黃金分割法求根
- **用途**: 非線性方程求解

### 9. contr3-6.0.f (輔助函數)

#### 基本資訊
- **版本**: 6.0
- **功能**: 輔助計算和控制函數

## 📊 程式流程圖

```
MultInt3-6.4.f (主程式)
│
├── 讀取輸入參數 (fort_MultInt.9)
├── 初始化設定
│
└── 電壓掃描迴圈
    │
    ├── 呼叫 semirhomult-6.0.f
    │   └── 建立體電荷密度表格
    │
    ├── 呼叫 surfrhomult-6.2.f  
    │   └── 建立表面電荷密度表格
    │
    ├── 呼叫 semitip3-6.1.f
    │   ├── 多網格 Poisson 求解
    │   ├── 呼叫 gsect-6.0.f (非線性求解)
    │   └── 返回電位分佈
    │
    ├── 呼叫 potcut3-6.0.f
    │   └── 提取電位剖面
    │
    └── 呼叫 intcurr-6.2.f
        └── 計算穿隧電流
```

## 🔗 模組間依賴關係

```
MultInt3-6.4.f
│
├── semitip3-6.1.f
│   ├── gsect-6.0.f
│   ├── RHOSURF (MultInt內部)
│   └── RHOBULK (MultInt內部)
│
├── semirhomult-6.0.f
├── surfrhomult-6.2.f  
├── potcut3-6.0.f
├── potexpand-6.1.f
├── intcurr-6.2.f
└── contr3-6.0.f
```

## 📝 關鍵觀察

### 程式設計特點
1. **高度模組化**: 每個檔案負責特定功能
2. **COMMON 區塊**: 廣泛使用 COMMON 區塊共享資料
3. **多維陣列**: 大量使用 3D/4D 陣列儲存空間資料
4. **數值方法**: 成熟的數值算法實現

### 計算流程特點
1. **預計算表格**: 事先建立電荷密度插值表
2. **多網格求解**: 從粗到細的網格求解策略
3. **非線性迭代**: 使用 GSECT 處理非線性問題
4. **空間離散**: 複雜的 3D 空間離散化

### 潛在翻譯挑戰
1. **COMMON 區塊**: 需要轉換為物件導向設計
2. **GOTO 語句**: 需要重構為結構化流程
3. **陣列索引**: Fortran 1-based vs Python 0-based
4. **數值精度**: 確保浮點運算精度一致

---

**分析完成日期**: 2025-06-06  
**下一步**: 分析對應的 Python 程式碼結構
